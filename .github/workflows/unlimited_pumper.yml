name: Market Data Pumper

on:
  schedule:
    - cron: '*/5 * * * *' # Every 5 minutes
  workflow_dispatch:

jobs:
  pump-data:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch and Deliver Intel
        run: |
          # 1. Fetch Global Dominance
          # Added --compressed and removed unnecessary headers that sometimes trigger WAFs
          GLOBAL_DATA=$(curl -s --compressed \
            -H "x-cg-demo-api-key: ${{ secrets.COINGECKO_API_KEY }}" \
            -H "Accept: application/json" \
            "https://api.coingecko.com/api/v3/global")
          
          GLOBAL_DOM=$(echo "$GLOBAL_DATA" | jq -r '.data.market_cap_percentage.btc' 2>/dev/null)

          if [[ -z "$GLOBAL_DOM" || "$GLOBAL_DOM" == "null" ]]; then
            echo "❌ API ERROR: CoinGecko returned invalid data."
            echo "Response: $GLOBAL_DATA"
            exit 1
          fi

          # 2. Fetch Binance Dominance Index
          BINANCE_INDEX=$(curl -s "https://fapi.binance.com/fapi/v1/ticker/price?symbol=BTCDOMUSDT" | jq -r '.price')

          # 3. Calculate Calibration Divisor
          # Fix: We add a leading zero using awk because 'bc' outputs .85 instead of 0.85, which breaks JSON
          DIVISOR=$(echo "scale=6; $BINANCE_INDEX / $GLOBAL_DOM" | bc -l | awk '{printf "%.6f", $0}')

          # 4. Fetch Top 10 Narratives
          SECTORS=$(curl -s --compressed \
            -H "x-cg-demo-api-key: ${{ secrets.COINGECKO_API_KEY }}" \
            "https://api.coingecko.com/api/v3/coins/categories" | jq -r '[.[] | select(.market_cap_change_24h != null)] | sort_by(.market_cap_change_24h) | reverse | .[0:10] | map("\(.name): \(.market_cap_change_24h | tonumber | round / 1)%") | join(", ")')

          # 5. Deliver to Vercel KV (Using your Vercel backend URL)
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST "https://crypto-ai-tool.vercel.app/api/analyze" \
            -H "Authorization: Bearer ${{ secrets.INTERNAL_SYNC_SECRET }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"btcPrice\": \"LIVE\",
              \"btcChange\": \"0.00\",
              \"btcDominance\": \"$GLOBAL_DOM%\",
              \"sectors\": \"$SECTORS\",
              \"divisor\": $DIVISOR
            }")

          if [ "$RESPONSE" -eq 200 ]; then
            echo "✅ SUCCESS: Data synced to Vercel KV (Status: $RESPONSE)"
          else
            echo "❌ ERROR: Vercel rejected the data (Status: $RESPONSE)"
            exit 1
          fi
