name: Market Data Pumper

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

jobs:
  pump-data:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch, Calculate, and Sync
        run: |
          GLOBAL_DATA=$(curl -s -H "X-CMC_PRO_API_KEY: ${{ secrets.CMC_PRO_API_KEY }}" -H "accept: application/json" "https://pro-api.coinmarketcap.com/v1/global-metrics/quotes/latest")
          
          GLOBAL_DOM=$(echo "$GLOBAL_DATA" | jq -r '.data.btc_dominance' 2>/dev/null)

          if [[ -z "$GLOBAL_DOM" || "$GLOBAL_DOM" == "null" ]]; then
            echo "Global Metrics API failed"
            exit 1
          fi
          
          BINANCE_INDEX=$(curl -s "https://fapi.binance.com/fapi/v1/ticker/price?symbol=BTCDOMUSDT" | jq -r '.price')
          
          DIVISOR=$(echo "scale=6; $BINANCE_INDEX / $GLOBAL_DOM" | bc -l)

          SECTORS=$(curl -s -H "X-CMC_PRO_API_KEY: ${{ secrets.CMC_PRO_API_KEY }}" -H "accept: application/json" "https://pro-api.coinmarketcap.com/v1/cryptocurrency/categories?start=1&limit=20" | jq -r '[.data[] | select(.market_cap_change_24h != null)] | sort_by(.market_cap_change_24h) | reverse | .[0:10] | map("\(.name): \(.market_cap_change_24h | tonumber | . * 100 | round / 100)%") | join(", ")')

          [[ -z "$SECTORS" ]] && SECTORS="AI: 0.0%, Meme: 0.0%"

          curl -X POST "https://www.aichartsniper.com/api/analyze" \
            -H "Authorization: Bearer ${{ secrets.INTERNAL_SYNC_SECRET }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"divisor\": $DIVISOR,
              \"sectors\": \"$SECTORS\",
              \"btcPrice\": \"auto\",
              \"btcChange\": \"0.00\",
              \"btcDominance\": \"$GLOBAL_DOM%\"
            }"
