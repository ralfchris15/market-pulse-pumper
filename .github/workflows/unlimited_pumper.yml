name: Market Data Pumper

on:
  schedule:
    - cron: '*/5 * * * *' # Every 5 minutes (Unlimited in Public Repos)
  workflow_dispatch:      # Allows you to manually trigger a sync

jobs:
  pump-data:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch, Calculate, and Sync
        run: |
          # 1. Fetch Global Dominance from CMC Public Endpoint
          # Using an alternate source to bypass current API blocks
          GLOBAL_DATA=$(curl -s "https://api.coinmarketcap.com/data-api/v3/global-metrics/quotes/latest")
          GLOBAL_DOM=$(echo $GLOBAL_DATA | jq -r '.data.btcDominance')

          # üö® Error Catch: Exit if the data is blocked or empty
          if [[ -z "$GLOBAL_DOM" || "$GLOBAL_DOM" == "null" ]]; then
            echo "‚ùå ERROR: Data source blocked. Check source availability."
            exit 1
          fi
          
          # 2. Fetch Binance Dominance Index
          BINANCE_INDEX=$(curl -s "https://fapi.binance.com/fapi/v1/ticker/price?symbol=BTCDOMUSDT" | jq -r '.price')
          
          # 3. Compute the Calibration Divisor
          # Formula: Binance Index / Real Global Dominance
          DIVISOR=$(echo "scale=6; $BINANCE_INDEX / $GLOBAL_DOM" | bc)

          # 4. Fetch Top 10 Trending Crypto Narratives (Heatmap)
          SECTORS=$(curl -s "https://api.coinmarketcap.com/data-api/v3/cryptocurrency/category/listing?start=1&limit=10&sortBy=market_cap_change_24h&sortType=desc" | jq -r '[.data.cryptoCategories[] | "\(.name): \(.marketCapChange24h | tonumber | . * 100 | round / 100)%"] | join(", ")')

          # 5. Push Data to your Vercel Vault
          # Fallback: If sectors fail, send a default to prevent script crash
          [[ -z "$SECTORS" ]] && SECTORS="AI: 0.0%, Meme: 0.0%"

          curl -X POST https://aichartsniper.com/api/analyze \
            -H "Authorization: Bearer ${{ secrets.INTERNAL_SYNC_SECRET }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"divisor\": $DIVISOR,
              \"sectors\": \"$SECTORS\",
              \"btcPrice\": \"auto\",
              \"btcChange\": \"0.00\",
              \"btcDominance\": \"$GLOBAL_DOM%\"
            }"
