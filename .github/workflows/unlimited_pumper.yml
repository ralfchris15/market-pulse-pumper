name: Market Data Pumper

on:
  schedule:
    - cron: '*/2 * * * *'
  workflow_dispatch:

jobs:
  pump-data:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch and Deliver Intel
        run: |
          # 1. Fetch Global Dominance from CoinGecko
          GLOBAL_DATA=$(curl -s --compressed \
            -H "accept: application/json" \
            -H "x-cg-demo-api-key: ${{ secrets.COINGECKO_API_KEY }}" \
            "https://api.coingecko.com/api/v3/global")
          
          GLOBAL_DOM=$(echo "$GLOBAL_DATA" | jq -r '.data.market_cap_percentage.btc')

          # 2. Fetch Binance Dominance Index & BTC Price
          # Fetching the real BTC ticker for HUD/AI (Added as requested)
          BINANCE_BTC=$(curl -s "https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT")
          BTC_PRICE=$(echo "$BINANCE_BTC" | jq -r '.lastPrice')
          BTC_CHANGE=$(echo "$BINANCE_BTC" | jq -r '.priceChangePercent')

          BINANCE_INDEX=$(curl -s "https://fapi.binance.com/fapi/v1/ticker/price?symbol=BTCDOMUSDT" | jq -r '.price')

          # 3. Calculate Calibration Divisor
          RAW_DIVISOR=$(echo "scale=6; $BINANCE_INDEX / $GLOBAL_DOM" | bc -l)
          DIVISOR=$(printf "%.6f" $RAW_DIVISOR)

          # 4. Fetch ALL Narratives (600+) and Save to Variable
          SECTORS=$(curl -s --compressed \
            -H "accept: application/json" \
            -H "x-cg-demo-api-key: ${{ secrets.COINGECKO_API_KEY }}" \
             "https://api.coingecko.com/api/v3/coins/categories" | jq -r '[.[] | select(.market_cap_change_24h != null)] | sort_by(.market_cap_change_24h) | reverse | map("\(.name): \(.market_cap_change_24h | tonumber | . * 10 | round / 10)%") | join(", ")')

          # 5. GENERATE SECURE JSON PAYLOAD FILE
          # Maps the new BTC_PRICE and BTC_CHANGE into the payload
          jq -n \
            --arg btcPrice "$BTC_PRICE" \
            --arg btcChange "$BTC_CHANGE" \
            --arg btcDom "$GLOBAL_DOM%" \
            --arg sec "$SECTORS" \
            --arg div "$DIVISOR" \
            '{btcPrice: $btcPrice, btcChange: $btcChange, btcDominance: $btcDom, sectors: $sec, divisor: ($div|tonumber)}' > payload.json

          # 6. Deliver to Vercel via @ notation
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST "https://crypto-ai-tool.vercel.app/api/analyze" \
            -H "Authorization: Bearer ${{ secrets.INTERNAL_SYNC_SECRET }}" \
            -H "Content-Type: application/json" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)" \
            -H "Origin: https://aichartsniper.com" \
            -d @payload.json)

          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "✅ SUCCESS: $HTTP_STATUS - Full Market Map Synchronized."
          else
            echo "❌ CRITICAL ERROR: Vercel rejected payload with Status $HTTP_STATUS"
            cat payload.json
            exit 1
          fi
