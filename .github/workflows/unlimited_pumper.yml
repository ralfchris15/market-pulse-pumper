name: Market Data Pumper

on:
  schedule:
    - cron: '*/1 * * * *'
  workflow_dispatch:

jobs:
  pump-data:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch and Deliver Intel
        env:
          BINANCE_API_KEY: ${{ secrets.BINANCE_API_KEY }}
          CRYPTOPANIC_KEY: ${{ secrets.CRYPTOPANIC_KEY }}
        run: |
          set -e

          # 1. Fetch Global Dominance from CoinGecko
          GLOBAL_DATA=$(curl -s --compressed \
            -H "accept: application/json" \
            -H "x-cg-demo-api-key: ${{ secrets.COINGECKO_API_KEY }}" \
            "https://api.coingecko.com/api/v3/global")

          GLOBAL_DOM=$(echo "$GLOBAL_DATA" | jq -r '.data.market_cap_percentage.btc // empty')

          # 2. Fetch BTC Price & Change (Binance with API Key + Fallback)
          echo "Attempting Binance Fetch..."
          BINANCE_BTC=$(curl -s -H "X-MBX-APIKEY: $BINANCE_API_KEY" \
            "https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT")

          BTC_PRICE=$(echo "$BINANCE_BTC" | jq -r '.lastPrice // empty')
          BTC_CHANGE=$(echo "$BINANCE_BTC" | jq -r '.priceChangePercent // empty')

          if [ -z "$BTC_PRICE" ] || [ "$BTC_PRICE" = "null" ]; then
            echo "⚠️ Binance Rate-Limited. Deploying CoinGecko Fallback..."
            CG_FALLBACK=$(curl -s --compressed \
              -H "accept: application/json" \
              -H "x-cg-demo-api-key: ${{ secrets.COINGECKO_API_KEY }}" \
              "https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&include_24hr_change=true")

            BTC_PRICE=$(echo "$CG_FALLBACK" | jq -r '.bitcoin.usd // empty')
            BTC_CHANGE=$(echo "$CG_FALLBACK" | jq -r '.bitcoin.usd_24h_change // empty')
          fi

          # 3. Fetch Binance Dominance Index (BTCDOMUSDT) — SAFE MODE
          echo "Fetching BTCDOMUSDT 24hr data..."
          BINANCE_DOM_24HR=$(curl -s -H "X-MBX-APIKEY: $BINANCE_API_KEY" \
            "https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=BTCDOMUSDT")

          if echo "$BINANCE_DOM_24HR" | jq -e . >/dev/null 2>&1; then
            BINANCE_DOM=$(echo "$BINANCE_DOM_24HR" | jq -r '.lastPrice // "0.00"')
            DOM_CHANGE=$(echo "$BINANCE_DOM_24HR" | jq -r '.priceChangePercent // "0.00"')
          else
            echo "⚠️ Invalid Binance DOM response. Using safe defaults."
            BINANCE_DOM="0.00"
            DOM_CHANGE="0.00"
          fi

          # 4. Final Safety Check
          if [ -z "$BTC_PRICE" ] || [ "$BTC_PRICE" = "null" ]; then
            echo "❌ CRITICAL: All Price APIs failed. Aborting."
            exit 1
          fi

          # 5. Calculate Calibration Divisor
          RAW_DIVISOR=$(echo "scale=6; $BINANCE_DOM / $GLOBAL_DOM" | bc -l)
          DIVISOR=$(printf "%.6f" $RAW_DIVISOR)

          # 6. Fetch ALL Narratives
          SECTORS=$(curl -s --compressed \
            -H "accept: application/json" \
            -H "x-cg-demo-api-key: ${{ secrets.COINGECKO_API_KEY }}" \
            "https://api.coingecko.com/api/v3/coins/categories" \
            | jq -r '[.[] | select(.market_cap_change_24h != null)]
                     | sort_by(.market_cap_change_24h)
                     | reverse
                     | map("\(.name): \(.market_cap_change_24h | tonumber | . * 10 | round / 10)%")
                     | join(", ")')

          # 6.5 Fetch BTC Global News (Last 4 Hours)
          BTC_NEWS_RAW=$(curl -s \
            "https://cryptopanic.com/api/v1/posts/?auth_token=$CRYPTOPANIC_KEY&currencies=BTC&public=true")

          BTC_NEWS=$(echo "$BTC_NEWS_RAW" | jq '
            [.results[]
              | select((now - (.published_at | fromdateiso8601)) <= 14400)
              | {
                  title: .title,
                  source: (.source.title // "Unknown"),
                  publishedAt: .published_at
                }
            ] | .[:3]
          ')

          # 7. GENERATE SECURE JSON PAYLOAD FILE
          jq -n \
            --arg btcPrice "$BTC_PRICE" \
            --arg btcChange "$BTC_CHANGE" \
            --arg btcDom "$GLOBAL_DOM%" \
            --arg domChange "$DOM_CHANGE" \
            --arg sec "$SECTORS" \
            --arg div "$DIVISOR" \
            --argjson btcNews "$BTC_NEWS" \
            '{
              btcPrice: $btcPrice,
              btcChange: $btcChange,
              btcDominance: $btcDom,
              btcDomChange: $domChange,
              sectors: $sec,
              divisor: ($div | tonumber),
              btcNews: $btcNews
            }' > payload.json

          # 8. Deliver to Vercel
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            "https://crypto-ai-tool.vercel.app/api/analyze" \
            -H "Authorization: Bearer ${{ secrets.INTERNAL_SYNC_SECRET }}" \
            -H "Content-Type: application/json" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)" \
            -H "Origin: https://aichartsniper.com" \
            -d @payload.json)

          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "✅ SUCCESS: $HTTP_STATUS - Full Market Map Synchronized."
          else
            echo "❌ ERROR: Vercel Status $HTTP_STATUS"
            cat payload.json
            exit 1
          fi
