name: Market Data Pumper

on:
  schedule:
    - cron: '*/1 * * * *'
  workflow_dispatch:

jobs:
  pump-data:
    runs-on: ubuntu-latest
    steps:

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq bc xmlstarlet

      - name: Fetch and Deliver Intel
        env:
          BINANCE_API_KEY: ${{ secrets.BINANCE_API_KEY }}
          COINGECKO_API_KEY: ${{ secrets.COINGECKO_API_KEY }}
          INTERNAL_SYNC_SECRET: ${{ secrets.INTERNAL_SYNC_SECRET }}
        run: |
          set -e

          ############################################
          # 1. GLOBAL BTC DOMINANCE (COINGECKO)
          ############################################
          GLOBAL_DATA=$(curl -s --compressed \
            -H "accept: application/json" \
            -H "x-cg-demo-api-key: $COINGECKO_API_KEY" \
            "https://api.coingecko.com/api/v3/global")

          GLOBAL_DOM=$(echo "$GLOBAL_DATA" | jq -r '.data.market_cap_percentage.btc')

          ############################################
          # 2. BTC PRICE & 24H CHANGE (BINANCE → CG)
          ############################################
          BINANCE_BTC=$(curl -s -H "X-MBX-APIKEY: $BINANCE_API_KEY" \
            "https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT")

          BTC_PRICE=$(echo "$BINANCE_BTC" | jq -r '.lastPrice')
          BTC_CHANGE=$(echo "$BINANCE_BTC" | jq -r '.priceChangePercent')

          if [ -z "$BTC_PRICE" ] || [ "$BTC_PRICE" = "null" ]; then
            CG_FALLBACK=$(curl -s --compressed \
              -H "accept: application/json" \
              -H "x-cg-demo-api-key: $COINGECKO_API_KEY" \
              "https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&include_24hr_change=true")

            BTC_PRICE=$(echo "$CG_FALLBACK" | jq -r '.bitcoin.usd')
            BTC_CHANGE=$(echo "$CG_FALLBACK" | jq -r '.bitcoin.usd_24h_change')
          fi

          ############################################
          # 3. BTC DOM INDEX (BINANCE)
          ############################################
          BINANCE_DOM_24HR=$(curl -s -H "X-MBX-APIKEY: $BINANCE_API_KEY" \
            "https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=BTCDOMUSDT")

          BINANCE_DOM=$(echo "$BINANCE_DOM_24HR" | jq -r '.lastPrice // "0.00"')

          ############################################
          # 4. CALIBRATION DIVISOR
          ############################################
          RAW_DIVISOR=$(echo "scale=6; $BINANCE_DOM / $GLOBAL_DOM" | bc -l)
          DIVISOR=$(printf "%.6f" $RAW_DIVISOR)

          ############################################
          # 5. NARRATIVE HEATMAP
          ############################################
          SECTORS=$(curl -s --compressed \
            -H "accept: application/json" \
            -H "x-cg-demo-api-key: $COINGECKO_API_KEY" \
            "https://api.coingecko.com/api/v3/coins/categories" |
            jq -r '[.[] | select(.market_cap_change_24h != null)]
              | sort_by(.market_cap_change_24h)
              | reverse
              | map("\(.name): \(.market_cap_change_24h | tonumber | . * 10 | round / 10)%")
              | join(", ")')

          ############################################
          # 6. BTC GLOBAL NEWS (RAW RSS – GUARANTEED)
          ############################################
          fetch_rss () {
            curl -s "$1" |
            xmlstarlet sel -t -m "//item[position()<=3]" \
              -v "concat('{\"title\":\"', normalize-space(title), '\",\"source\":\"$2\",\"publishedAt\":\"', normalize-space(pubDate), '\"}')" -n
          }

          BTC_NEWS=$(printf "[%s]" "$((
            fetch_rss "https://www.coindesk.com/arc/outboundfeeds/rss/?tags=bitcoin" "CoinDesk"
            fetch_rss "https://cointelegraph.com/rss/tag/bitcoin" "CoinTelegraph"
          ) | sed 's/}$/},/g' | sed '$ s/,$//' )")

          ############################################
          # 7. BUILD PAYLOAD
          ############################################
          jq -n \
            --arg btcPrice "$BTC_PRICE" \
            --arg btcChange "$BTC_CHANGE" \
            --arg btcDom "$GLOBAL_DOM%" \
            --arg sec "$SECTORS" \
            --arg div "$DIVISOR" \
            --argjson btcNews "$BTC_NEWS" \
            '{
              btcPrice: $btcPrice,
              btcChange: $btcChange,
              btcDominance: $btcDom,
              sectors: $sec,
              divisor: ($div | tonumber),
              btcNews: $btcNews
            }' > payload.json

          ############################################
          # 8. DELIVER TO BACKEND
          ############################################
          curl -s -X POST \
            "https://crypto-ai-tool.vercel.app/api/analyze" \
            -H "Authorization: Bearer $INTERNAL_SYNC_SECRET" \
            -H "Content-Type: application/json" \
            -H "Origin: https://aichartsniper.com" \
            -d @payload.json
