name: Market Data Pumper

on:
  schedule:
    - cron: '*/1 * * * *'
  workflow_dispatch:

jobs:
  pump-data:
    runs-on: ubuntu-latest
    steps:

      - name: Fetch and Deliver Intel
        env:
          BINANCE_API_KEY: ${{ secrets.BINANCE_API_KEY }}
          COINGECKO_API_KEY: ${{ secrets.COINGECKO_API_KEY }}
        run: |
          # The main workflow runs with set -e (exit on error)
          set -e

          ############################################
          # 1. GLOBAL BTC DOMINANCE (COINGECKO)
          ############################################
          GLOBAL_DATA=$(curl -s --compressed \
            -H "accept: application/json" \
            -H "x-cg-demo-api-key: $COINGECKO_API_KEY" \
            "api.coingecko.com")

          GLOBAL_DOM=$(echo "$GLOBAL_DATA" | jq -r '.data.market_cap_percentage.btc // empty')

          ############################################
          # 2. BTC PRICE & 24H CHANGE (BINANCE ‚Üí CG)
          ############################################
          echo "Attempting Binance Fetch..."
          # The previous logic was already robust for this part if the API returned non-JSON/rate-limited error
          BINANCE_BTC=$(curl -s -H "X-MBX-APIKEY: $BINANCE_API_KEY" \
            "api.binance.com")

          BTC_PRICE=$(echo "$BINANCE_BTC" | jq -r '.lastPrice // empty')
          BTC_CHANGE=$(echo "$BINANCE_BTC" | jq -r '.priceChangePercent // empty')

          if [ -z "$BTC_PRICE" ] || [ "$BTC_PRICE" = "null" ]; then
            echo "‚ö†Ô∏è Binance Rate-Limited. Using CoinGecko fallback..."
            CG_FALLBACK=$(curl -s --compressed \
              -H "accept: application/json" \
              -H "x-cg-demo-api-key: $COINGECKO_API_KEY" \
              "api.coingecko.com")

            BTC_PRICE=$(echo "$CG_FALLBACK" | jq -r '.bitcoin.usd')
            BTC_CHANGE=$(echo "$CG_FALLBACK" | jq -r '.bitcoin.usd_24h_change')
          fi

          ############################################
          # 3. BTC DOM INDEX (BINANCE SAFE MODE)
          ############################################
          echo "Fetching BTCDOMUSDT 24hr data..."
          BINANCE_DOM_24HR=$(curl -s -H "X-MBX-APIKEY: $BINANCE_API_KEY" \
            "fapi.binance.com")

          if echo "$BINANCE_DOM_24HR" | jq -e . >/dev/null 2>&1; then
            BINANCE_DOM=$(echo "$BINANCE_DOM_24HR" | jq -r '.lastPrice // "0.00"')
            DOM_CHANGE=$(echo "$BINANCE_DOM_24HR" | jq -r '.priceChangePercent // "0.00"')
          else
            echo "‚ö†Ô∏è Invalid Binance DOM response. Using defaults."
            BINANCE_DOM="0.00"
            DOM_CHANGE="0.00"
          fi

          ############################################
          # 4. FINAL SAFETY CHECK
          ############################################
          if [ -z "$BTC_PRICE" ]; then
            echo "‚ùå CRITICAL: BTC price unavailable."
            exit 1
          fi

          ############################################
          # 5. CALIBRATION DIVISOR
          ############################################
          RAW_DIVISOR=$(echo "scale=6; $BINANCE_DOM / $GLOBAL_DOM" | bc -l)
          DIVISOR=$(printf "%.6f" $RAW_DIVISOR)

          ############################################
          # 6. NARRATIVE HEATMAP
          ############################################
          SECTORS=$(curl -s --compressed \
            -H "accept: application/json" \
            -H "x-cg-demo-api-key: $COINGECKO_API_KEY" \
            "api.coingecko.com" |
            jq -r '[.[] | select(.market_cap_change_24h != null)]
              | sort_by(.market_cap_change_24h)
              | reverse
              | map("\(.name): \(.market_cap_change_24h | tonumber | . * 10 | round / 10)%")
              | join(", ")')

          ############################################
          # 6.5 BTC GLOBAL NEWS (RAW RSS ‚Äî FIXED CODE)
          ############################################
          echo "üì∞ Fetching BTC global news..."

          # Modified fetch_rss function to be robust to curl errors internally
          fetch_rss () {
            local url=$1
            local source_name=$2
            local response
            
            # Temporarily disable set -e within the function to handle potential curl/network errors
            set +e 
            response=$(curl -s "$url")
            if [ $? -ne 0 ]; then
              echo "Error fetching RSS from $source_name, skipping." >&2
              set -e # Re-enable set -e before exiting function if an error occurred
              return 1
            fi
            set -e # Re-enable set -e for normal execution

            # Process the response with awk
            echo "$response" | \
            sed -e 's/&lt;/</g; s/&gt;/>/g; s/&amp;/\&/g' | \
            awk -v SRC="$source_name" '
              /<item>/,/<\/item>/ {
                if ($0 ~ /<title>/) {
                  gsub(/.*<title>|<\/title>.*/, "", $0)
                  title=$0
                }
                if ($0 ~ /<pubDate>/) {
                  gsub(/.*<pubDate>|<\/pubDate>.*/, "", $0)
                  date=$0
                }
                if ($0 ~ /<\/item>/) {
                  printf("{\"title\":\"%s\",\"source\":\"%s\",\"publishedAt\":\"%s\"}\n", title, SRC, date)
                }
              }
            '
          }
          
          # Aggregate outputs from both feeds and process with jq
          # Errors in fetch_rss will now be handled internally and won't stop the script with set -e
          ALL_NEWS=$(
            fetch_rss "www.coindesk.com" "CoinDesk"
            fetch_rss "cointelegraph.com" "CoinTelegraph"
          )

          # Use a single jq command to filter and format the combined output into a valid JSON array
          BTC_NEWS=$(echo "$ALL_NEWS" | jq -s '
            unique_by(.title) | .[:3]
          ')

          ############################################
          # 7. BUILD PAYLOAD
          ############################################
          jq -n \
            --arg btcPrice "$BTC_PRICE" \
            --arg btcChange "$BTC_CHANGE" \
            --arg btcDom "$GLOBAL_DOM%" \
            --arg domChange "$DOM_CHANGE" \
            --arg sec "$SECTORS" \
            --arg div "$DIVISOR" \
            --argjson btcNews "$BTC_NEWS" \
            '{
              btcPrice: $btcPrice,
              btcChange: $btcChange,
              btcDominance: $btcDom,
              btcDomChange: $domChange,
              sectors: $sec,
              divisor: ($div | tonumber),
              btcNews: $btcNews
            }' > payload.json

          ############################################
          # 8. DELIVER TO BACKEND
          ############################################
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            "crypto-ai-tool.vercel.app" \
            -H "Authorization: Bearer ${{ secrets.INTERNAL_SYNC_SECRET }}" \
            -H "Content-Type: application/json" \
            -H "Origin: https://aichartsniper.com" \
            -d @payload.json)

          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "‚úÖ MARKET MAP SYNCED"
          else
            echo "‚ùå BACKEND ERROR: $HTTP_STATUS"
            cat payload.json
            exit 1
          fi
